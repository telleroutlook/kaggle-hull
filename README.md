# Hull Tactical - Market Prediction

## 竞赛概述

### 你能预测市场的可预测性吗？

你的任务是预测标普500指数（S&P 500）的超额收益，同时在管理波动性约束的情况下，力争获得优于标普500指数的回报。你的工作将检验有效市场假说（Efficient Market Hypothesis），并挑战个人理财的常规认知。

**竞赛状态**: 正在进行中（开始于1个月前，报名截止还有2个月）
## 竞赛描述

大多数个人理财专家认为试图"择时"市场是不负责任的。有效市场假说（EMH）也持相同观点：所有可知信息都已反映在价格中，因此不必尝试。

但在机器学习时代，不尝试择时市场是否反而是不负责任的呢？有效市场假说是否只是一个极度简化的模型，甚至可能是错误的？

这个竞赛不仅仅是关于预测建模。预测市场回报挑战了市场效率的假设。你的工作可能帮助重塑投资者和学术界对金融市场的理解。参与者可能会发现其他人忽略的信号，开发创新策略，并促进对市场行为的更深理解——可能重写现代金融的一个基本原则。

大多数投资者无法跑赢标普500指数。这一失败几十年来一直被用来支持有效市场假说：如果连专业人士都无法获胜，那一定是不可能的。这一观察长期以来一直被视为有效市场假说的证据——即价格已经反映了所有可用信息，不存在持久的优势。这个故事很简洁，但现实却并非如此。市场是嘈杂的、混乱的，充满了行为怪癖，并不会因为学术正统说它们应该消失就真的消失。

数据科学改变了游戏规则。拥有足够的特征、机器学习和创造力，就有可能发现理论上不应该存在的可重复优势。真正的挑战不是它们是否存在，而是你能否找到它们并以足够稳健的方式组合它们，以克服摩擦和实施问题。

我们目前的方法结合了几种量化模型来调整每个交易日收盘时的市场敞口。它指出了正确的方向，但像一个模糊的指南针。我们的模型明显是建模复杂、非线性、自适应系统的次优方式。这个竞赛要求你做得更好：构建一个预测超额收益的模型，并包含一个旨在跑赢标普500指数同时保持在120%波动率约束内的投资策略。我们将提供结合公共市场信息和专有数据集的每日数据，为你提供发现大多数人错过的模式的原材料。

与许多Kaggle挑战不同，这不仅仅是一个理论练习。你在这里构建的模型可能在实时投资策略中具有价值。如果你成功，你将不仅仅是改进一个预测引擎——你将帮助证明金融市场并非完全有效，挑战现代金融的基石之一，并为更好、更易用的投资工具铺平道路。
## 评估指标

竞赛的评估指标是一种变体的夏普比率，它会惩罚那些承担显著高于基础市场波动性或未能跑赢市场回报的策略。指标代码可在此处获取。

## 提交文件要求

你必须使用提供的评估API提交竞赛作品，这确保模型不会"窥视"未来数据。对于每个交易日，你需要预测持有标普500指数的最优资金分配比例。由于允许一定杠杆，有效范围为0到2。更多细节请参阅示例notebook。

### 推理服务器实现

- 入口脚本：`working/inference_server.py`。
- 该文件注册 `predict(test_batch)` 函数，使用在训练集上拟合的 `HullModel` 基线模型对每个批次进行推理，并自动将结果裁剪到 `[0, 2]` 区间，符合杠杆约束。
- `predict` 支持 Polars/Pandas 输入，返回带有 `prediction` 列的 `DataFrame`，满足 `default_gateway` 的流式校验要求。
- 通过 `kaggle_evaluation.default_inference_server.DefaultInferenceServer` 同时兼容：
  - Kaggle 复现容器（调用 `serve()`）；
  - Notebook/本地调试（调用 `run_local_gateway((data_dir,))`）。
- 流程结束后会生成官方要求的 `submission.parquet`，并额外导出 `submission.csv` 以方便快速查看。
## 时间线

这是一个预测竞赛，包含活跃的训练阶段和独立的预测阶段，模型将在预测阶段针对真实市场回报进行运行。

### 训练阶段时间线

- **开始日期**: 2025年9月16日
- **报名截止**: 2025年12月8日（必须在此日期前接受竞赛规则才能参赛）
- **团队合并截止**: 2025年12月8日（参与者加入或合并团队的最后一天）
- **最终提交截止**: 2025年12月15日

除非另有说明，所有截止日期均为相应日期的UTC时间23:59。竞赛组织者保留在认为必要时更新竞赛时间线的权利。

### 预测阶段时间线

最终提交截止日期后，排行榜将定期更新，以反映针对选定notebook运行的市场数据更新。

- **竞赛结束日期**: 2026年6月16日

## 奖金设置

- **第一名**: $50,000
- **第二名**: $25,000
- **第三名**: $10,000
- **第四名**: $5,000
- **第五名**: $5,000
- **第六名**: $5,000

**总奖金**: $100,000

## 代码要求

此竞赛的提交必须通过Notebook进行。为了使"提交"按钮在提交后激活，必须满足以下条件：

- CPU Notebook运行时间 ≤ 8小时
- GPU Notebook运行时间 ≤ 8小时
- 网络访问已禁用
- 允许使用自由公开的外部数据，包括预训练模型

### 预测阶段

在预测阶段，CPU和GPU notebook的运行时间限制将延长至9小时。你必须确保你的提交在此时间内完成。

额外的一小时是为了防止由于测试集扩展而导致的超时故障。但你仍需负责确保你的提交在9小时限制内完成。有关预测阶段扩展测试集的详细信息，请参阅数据页面。

有关如何提交的更多信息，请参阅代码竞赛FAQ。如果你遇到提交错误，请查看代码调试文档。

## 数据集描述

这个竞赛挑战你使用定制的市场数据特征集来预测标普500指数的每日收益。

### 竞赛阶段和数据更新

竞赛将分为两个阶段进行：

1. **模型训练阶段**：包含六个月历史数据的测试集。由于这些价格是公开可用的，此阶段的排行榜分数没有实际意义。
2. **预测阶段**：在提交截止后收集的测试集。你应该期望评分部分的测试集大小与第一阶段评分部分的测试集大致相同。

在预测阶段，评估API将从公共集的开始到私有集的结束提供测试数据。这包括提交截止日期之前的交易日，这些交易日将不会被评分。API提供的第一个date_id在整个竞赛期间将保持不变。

## 文件说明

### train.csv 历史市场数据

数据覆盖数十年的历史；预计早期数据会有大量缺失值。

- `date_id` - 单个交易日的标识符
- `M*` - 市场动态/技术特征
- `E*` - 宏观经济特征  
- `I*` - 利率特征
- `P*` - 价格/估值特征
- `V*` - 波动率特征
- `S*` - 情绪特征
- `MOM*` - 动量特征
- `D*` - 虚拟/二元特征
- `forward_returns` - 购买标普500指数并持有一天后的收益（仅训练集）
- `risk_free_rate` - 联邦基金利率（仅训练集）
- `market_forward_excess_returns` - 相对于预期的前向收益。通过减去滚动五年平均前向收益并使用中位数绝对偏差（MAD）进行winsorizing计算得出（仅训练集）

### test.csv 模拟测试集

代表未见过测试集结构的模拟测试集。用于公共排行榜的测试集是训练集中最后180个日期ID的副本。因此，公共排行榜分数没有实际意义。评估API提供的此文件的未见过副本可能在模型训练阶段更新。

- `date_id`
- `[feature_name]` - 特征列与train.csv相同
- `is_scored` - 该行是否计入评估指标计算。在模型训练阶段，只有前180行为true（仅测试集）
- `lagged_forward_returns` - 滞后一天的标普500指数收益（仅测试集）
- `lagged_risk_free_rate` - 滞后一天的联邦基金利率（仅测试集）
- `lagged_market_forward_excess_returns` - 滞后一天的超额收益（仅测试集）

### kaggle_evaluation/

评估API使用的文件。请参阅演示提交以了解如何使用API。

竞赛结束后，我们将定期在我们的网站上发布数据，欢迎你将其用于自己的交易。

## 运行与部署注意事项

- **统一模型类型**：通过 `HULL_MODEL_TYPE` 环境变量即可同时控制 CLI（`working/main.py`）与推理服务（`working/inference_server.py`）的默认模型类型。可使用 `--model-type` 显式覆盖，若未指定则日志会打印当前解析结果及 `HULL_MODEL_TYPE` 值。
- **OOF 校准 artefact**：执行 `python working/train_experiment.py --model-type lightgbm --n-splits 5` 会在 `working/artifacts/oof_summary.json` 中固化 TimeSeriesSplit 结果（Sharpe、杠杆、折线）。`main.py` 与 `inference_server.py` 会自动读取该文件并在 `--reuse-oof-scale`（默认开启）时复用最新的杠杆校准值，确保提交前后保持一致的尺度。
- **示例脚本 main_fixed.py**：`working/main_fixed.py` 仅用于演示 notebook 管线，默认阻止执行；若确需生成随机预测可显式传入 `--allow-random-baseline`。正式提交请始终使用 `working/main.py` 或 `working/inference_server.py`。
- **Kaggle 单元格运行**：`kaggle_simple_cell_fixed.py` 现支持 `VERBOSE=1`（打印更多检查详情）与 `FORCE_PIP_INSTALL=1`（强制安装 requirements），并以流式方式显示 pip/推理日志，便于定位 notebook 超时或 OOM 风险。
- **归档打包**：运行 `python create_kaggle_archive.py [--include-tests]` 会生成 `input/kaggle_hull_solver.zip` 及对应的 `.sha256` 校验文件。默认排除 `working/tests` 以缩小体积，若需要可加 `--include-tests`。归档始终包含 `working/artifacts/`，以确保 OOF artefact 能被部署端重用。
